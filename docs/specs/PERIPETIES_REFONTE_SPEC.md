# SpÃ©cification : Refonte Interface PÃ©ripÃ©ties

**Version** : 1.0
**Date** : 19 janvier 2026
**Statut** : Draft

---

## 1. Contexte et ProblÃ¨mes IdentifiÃ©s

### 1.1 ProblÃ¨mes Actuels

| ProblÃ¨me | Impact | Cause Racine |
|----------|--------|--------------|
| **DÃ©calage comptage** | Stats affichent 39, liste montre 18 | Stats comptent tous les statuts, liste filtre sur `pending` uniquement |
| **Mises Ã  jour incorrectes** | UI dÃ©synchronisÃ©e aprÃ¨s actions | ModÃ¨le optimiste sans WebSocket, polling manuel |
| **Confusion Ã©tat/dÃ©cision** | `pending`, `approved`, `rejected` mÃ©langÃ©s | ModÃ¨le de donnÃ©es mal structurÃ© |
| **Vocabulaire incohÃ©rent** | "Courrier", "plis", "flux" coexistent | Migration incomplÃ¨te vers "PÃ©ripÃ©ties" |
| **Liens cassÃ©s** | `/flux/{id}` retourne 404 | Routes renommÃ©es mais liens non mis Ã  jour |
| **Mode Focus mal positionnÃ©** | PrÃ©sentÃ© comme un filtre | C'est un mode de travail distinct |

### 1.2 Flux Non ReprÃ©sentÃ©s

Le modÃ¨le actuel ne capture pas :
- Les items en cours d'analyse (`analyzing`)
- Les items en attente d'analyse (`queued`)
- Les items traitÃ©s automatiquement (`auto_applied`)
- Les erreurs d'analyse ou d'action (`error`)

---

## 2. Nouvelle Architecture de DonnÃ©es

### 2.1 SÃ©paration Ã‰tat / RÃ©solution / Snooze

**Principe** : Ne pas confondre *oÃ¹ en est l'item dans le pipeline* avec *comment il a Ã©tÃ© rÃ©solu*.

```typescript
interface PeripetieItem {
  id: string;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ã‰TAT DU PIPELINE (oÃ¹ en est-on ?)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  state: PeripetieState;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RÃ‰SOLUTION (comment Ã§a s'est terminÃ© ?)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  resolution: PeripetieResolution | null;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SNOOZE (orthogonal - report temporaire)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  snooze: PeripetieSnooze | null;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ERREUR (si state = 'error')
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  error: PeripetieError | null;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMESTAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  queued_at: string;              // ISO datetime
  analysis_started_at?: string;
  analysis_completed_at?: string;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DONNÃ‰ES MÃ‰TIER (inchangÃ©)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  metadata: PeripetieMetadata;
  analysis: PeripetieAnalysis;
  content: PeripetieContent;
}
```

### 2.2 Ã‰tats du Pipeline

```typescript
type PeripetieState =
  | 'queued'           // ReÃ§u, en attente d'analyse
  | 'analyzing'        // Sancho travaille dessus
  | 'awaiting_review'  // AnalysÃ©, attend dÃ©cision humaine
  | 'processed'        // Traitement terminÃ© (auto ou manuel)
  | 'error';           // Ã‰chec quelque part
```

**Diagramme de transition :**

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚            EMAIL ARRIVE                 â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â†“
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚   queued     â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â†“
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  analyzing   â”‚ â† Sancho multi-pass
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â†“                    â†“                    â†“
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  error  â”‚         â”‚ processed â”‚        â”‚  awaiting   â”‚
                 â”‚         â”‚         â”‚  (auto)   â”‚        â”‚   _review   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                                 â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
                                  â†“                              â†“     â†“
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                           â”‚ processed â”‚                  â”‚  snoozed  â”‚â”‚
                           â”‚ (manual)  â”‚                  â”‚ (revient) â”‚â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜â”‚
                                                                â†“      â”‚
                                                         awaiting_review
```

### 2.3 Types de RÃ©solution

```typescript
interface PeripetieResolution {
  type: ResolutionType;
  action_taken: string;        // 'archive', 'delete', 'task', 'keep', etc.
  resolved_at: string;         // ISO datetime
  resolved_by: 'system' | 'user';

  // DÃ©tails optionnels
  confidence_at_resolution?: number;
  user_modified_action?: boolean;
  original_action?: string;    // Si modifiÃ© par l'utilisateur
}

type ResolutionType =
  | 'auto_applied'      // Confiance suffisante, appliquÃ© automatiquement
  | 'manual_approved'   // Humain a approuvÃ© l'action recommandÃ©e
  | 'manual_modified'   // Humain a modifiÃ© puis approuvÃ©
  | 'manual_rejected'   // Humain a rejetÃ© (aucune action)
  | 'manual_skipped';   // Humain a passÃ© sans dÃ©cision
```

### 2.4 Structure Snooze (Orthogonal)

```typescript
interface PeripetieSnooze {
  until: string;          // ISO datetime - quand revenir
  created_at: string;     // ISO datetime - quand snoozÃ©
  reason?: string;        // Raison optionnelle
  snooze_count: number;   // Nombre de fois snoozÃ©
}
```

**Important** : Un item snoozÃ© reste en `state: 'awaiting_review'` avec un `snooze.until` futur.

### 2.5 Structure Erreur

```typescript
interface PeripetieError {
  type: ErrorType;
  message: string;
  occurred_at: string;     // ISO datetime
  retryable: boolean;
  retry_count: number;
  last_retry_at?: string;
}

type ErrorType =
  | 'analysis_failed'    // Sancho n'a pas pu analyser
  | 'action_failed'      // Analyse OK mais action Ã©chouÃ©e (IMAP down, etc.)
  | 'enrichment_failed'  // Notes/tÃ¢ches n'ont pas pu Ãªtre crÃ©Ã©es
  | 'timeout';           // Timeout pendant traitement
```

---

## 3. Architecture Interface Utilisateur

### 3.1 Structure Globale de la Page

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  ğŸ­ Les PÃ©ripÃ©ties                              [ğŸ¯ Mode Focus]    â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€ NAVIGATION (Onglets par Ã‰tat) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  ğŸ“¥ Ã€ traiter (18)  â”‚  â³ En cours (3)  â”‚  ğŸ’¤ ReportÃ©es (21)       â”‚â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚  â”‚  âœ… Historique (147)              â”‚  âš ï¸ Erreurs (2)                â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€ ACTIONS QUEUE (Barre d'outils) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  [ğŸ“¬ RÃ©cupÃ©rer]  [ğŸ”„ RÃ©analyser]  â”‚  Tri: [Plus ancien â–¼]  â”‚  âš™ï¸  â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€ CONTENU (Selon Onglet Actif) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  [Vue item unique OU Liste selon contexte]                         â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Onglets de Navigation

| Onglet | IcÃ´ne | Filtre | Comportement |
|--------|-------|--------|--------------|
| **Ã€ traiter** | ğŸ“¥ | `state=awaiting_review` AND `snooze=null` | Vue item unique (traitement sÃ©quentiel) |
| **En cours** | â³ | `state=queued` OR `state=analyzing` | Liste avec indicateurs de progression |
| **ReportÃ©es** | ğŸ’¤ | `state=awaiting_review` AND `snooze.until > now` | Liste avec date de retour |
| **Historique** | âœ… | `state=processed` | Liste avec sous-filtres |
| **Erreurs** | âš ï¸ | `state=error` | Liste avec options de retry |

### 3.3 Sous-filtres Historique

```
â”Œâ”€ Historique (147) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  [Tous (147)] [âš¡ Auto (89)] [âœ“ ApprouvÃ©s (52)] [âœ— RejetÃ©s (6)]       â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Liste â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  ...                                                              â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Sous-filtre | Filtre |
|-------------|--------|
| **Tous** | `state=processed` |
| **Auto** | `resolution.type=auto_applied` |
| **ApprouvÃ©s** | `resolution.type IN (manual_approved, manual_modified)` |
| **RejetÃ©s** | `resolution.type=manual_rejected` |

### 3.4 Barre d'Actions Queue

SÃ©parÃ©e de la navigation, contient les actions sur la queue globale :

| Action | IcÃ´ne | Description | DisponibilitÃ© |
|--------|-------|-------------|---------------|
| **RÃ©cupÃ©rer** | ğŸ“¬ | Fetch nouveaux emails | Toujours |
| **RÃ©analyser** | ğŸ”„ | RÃ©analyser items sÃ©lectionnÃ©s ou tous | Onglet "Ã€ traiter" ou "Erreurs" |
| **Tri** | â–¼ | Plus ancien / Plus rÃ©cent / Confiance | Selon onglet |
| **ParamÃ¨tres** | âš™ï¸ | Seuils auto-apply, comptes, etc. | Toujours |

### 3.5 Mode Focus (SÃ©parÃ©)

Le Mode Focus est un **mode de travail distinct**, pas un onglet :

- **AccÃ¨s** : Bouton "ğŸ¯ Mode Focus" dans le header OU raccourci `F`
- **URL** : `/peripeties/focus`
- **Comportement** : Interface Ã©purÃ©e pour traitement rapide en sÃ©rie
- **Retour** : Bouton "Retour" ou `Escape` â†’ `/peripeties`

```
â”Œâ”€ Mode Focus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  [â† Retour]                          12 pÃ©ripÃ©ties restantes          â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ PÃ©ripÃ©tie Courante â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  [Contenu de l'email]                                          â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Actions Rapides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  [A] Archiver   [D] Supprimer   [T] TÃ¢che   [S] Snooze   [R] X â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.6 Vue DÃ©taillÃ©e d'une PÃ©ripÃ©tie (Transparence ComplÃ¨te)

La page de dÃ©tail d'une pÃ©ripÃ©tie (`/peripeties/{id}`) doit exposer **toute la chaÃ®ne de raisonnement** de Sancho pour permettre de comprendre et challenger l'analyse.

#### Structure de la Page DÃ©tail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Retour                                         [ğŸ”„ RÃ©analyser] [Actions] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 1. EN-TÃŠTE & MÃ‰TADONNÃ‰ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ğŸ“§ Sujet de l'email                                                    â”‚â”‚
â”‚  â”‚  De: expediteur@example.com                      ReÃ§u: il y a 2 heures â”‚â”‚
â”‚  â”‚  ğŸ“ 2 piÃ¨ces jointes                                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 2. DÃ‰CISION RECOMMANDÃ‰E â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  ğŸ—„ï¸ ARCHIVER                                    Confiance: â–ˆâ–ˆâ–ˆâ–ˆâ–‘ 87%   â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  "Cet email est une confirmation de rÃ©servation. Aucune action         â”‚â”‚
â”‚  â”‚   requise, archivage recommandÃ©."                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  CatÃ©gorie: ğŸ“‹ Administratif                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  [âœ“ Approuver]  [Modifier]  [âœ— Rejeter]  [ğŸ’¤ Reporter]                 â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 3. TRANSPARENCE DE L'ANALYSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 3.1 Badges de ComplexitÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  âš¡ Rapide (2 passes)  ğŸ” Contexte utilisÃ©  ğŸ§  Analyse approfondie â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 3.2 Timeline Multi-Pass â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  ğŸŸ¢ Pass 1 â€” Haiku (Extraction aveugle)           0% â†’ 45%  1.2s  â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ ğŸ’­ Questions: "Est-ce une rÃ©servation personnelle ou pro?" â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚                                                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚  ğŸŸ¢ Pass 2 â€” Haiku (Raffinement contextuel)      45% â†’ 72%  0.8s  â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ ğŸ” 3 notes consultÃ©es                                      â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ ğŸ’­ "VÃ©rifier si liÃ© au voyage prÃ©vu en mars"               â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚                                                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚  ğŸŸ  Pass 3 â€” Sonnet (Analyse approfondie)        72% â†’ 87%  2.1s  â”‚â”‚â”‚
â”‚  â”‚  â”‚      â””â”€ â†‘ Escalade (confiance < 80%)                               â”‚â”‚â”‚
â”‚  â”‚  â”‚      â””â”€ DÃ©cision finale: ARCHIVER                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚â”‚â”‚
â”‚  â”‚  â”‚  Total: 3 passes | 4.1s | 1,847 tokens | ArrÃªt: confiance atteinte â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 3.3 Ã‰volution de la Confiance (Sparkline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚     â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—                                                    â”‚â”‚â”‚
â”‚  â”‚  â”‚    â•±           87%                                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚   â•±                                                                 â”‚â”‚â”‚
â”‚  â”‚  â”‚  â—â”€â”€â”€â—                                                              â”‚â”‚â”‚
â”‚  â”‚  â”‚ 0%  45%  72%                                                        â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 4. CONTEXTE UTILISÃ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 4.1 Notes ConsultÃ©es â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  ğŸ“ "Voyage Japon Mars 2026" â€” pertinence: 92%                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  ğŸ“ "RÃ©servations en cours" â€” pertinence: 78%                      â”‚â”‚â”‚
â”‚  â”‚  â”‚  ğŸ“ "Contact: Agence Voyages Plus" â€” pertinence: 65%               â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 4.2 Influence du Contexte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  ğŸ’¡ Explication:                                                    â”‚â”‚â”‚
â”‚  â”‚  â”‚  "La note 'Voyage Japon' confirme que cette rÃ©servation est        â”‚â”‚â”‚
â”‚  â”‚  â”‚   attendue et correspond au planning prÃ©vu."                        â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  âœ… Confirmations:                                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚  â€¢ Dates cohÃ©rentes avec le voyage prÃ©vu (12-19 mars)              â”‚â”‚â”‚
â”‚  â”‚  â”‚  â€¢ HÃ´tel mentionnÃ© dans la note de planification                   â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  âš ï¸ Contradictions: Aucune                                         â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  â“ Informations manquantes:                                        â”‚â”‚â”‚
â”‚  â”‚  â”‚  â€¢ Confirmation du vol non encore reÃ§ue                            â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 4.3 Calendrier & TÃ¢ches â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  ğŸ“… "DÃ©part Japon" â€” 12 mars 2026                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚  â˜‘ï¸ "Finaliser rÃ©servations voyage" â€” due: 1 mars 2026             â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 5. RAISONNEMENT & CRITIQUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 5.1 Raisonnement Principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  "Cet email de booking.com confirme une rÃ©servation d'hÃ´tel Ã       â”‚â”‚â”‚
â”‚  â”‚  â”‚   Tokyo du 12 au 19 mars 2026. L'expÃ©diteur est vÃ©rifiÃ©, le        â”‚â”‚â”‚
â”‚  â”‚  â”‚   contenu correspond au voyage planifiÃ© dans les notes. Aucune     â”‚â”‚â”‚
â”‚  â”‚  â”‚   action immÃ©diate requise â€” la rÃ©servation est dÃ©jÃ  payÃ©e.        â”‚â”‚â”‚
â”‚  â”‚  â”‚   Recommandation: archiver pour rÃ©fÃ©rence future."                  â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 5.2 Alternatives ConsidÃ©rÃ©es (Why Not) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  âŒ CrÃ©er une tÃ¢che â€” RejetÃ© car:                                   â”‚â”‚â”‚
â”‚  â”‚  â”‚     "La rÃ©servation est confirmÃ©e et payÃ©e, pas d'action requise"  â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  âŒ Marquer important â€” RejetÃ© car:                                 â”‚â”‚â”‚
â”‚  â”‚  â”‚     "Information de rÃ©fÃ©rence, pas urgente"                        â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  âŒ RÃ©pondre â€” RejetÃ© car:                                          â”‚â”‚â”‚
â”‚  â”‚  â”‚     "Email automatique, pas de rÃ©ponse attendue"                   â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 5.3 Points d'Attention (High Stakes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  âš ï¸ Aucun point critique identifiÃ©                                 â”‚â”‚â”‚
â”‚  â”‚  â”‚  (Si prÃ©sent: montant financier, deadline, engagement, etc.)       â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 6. ENRICHISSEMENTS PROPOSÃ‰S â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 6.1 Notes Ã  CrÃ©er/Enrichir â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  [âœ“] ğŸ“ Enrichir "Voyage Japon Mars 2026"                          â”‚â”‚â”‚
â”‚  â”‚  â”‚      + Ajouter: confirmation hÃ´tel reÃ§ue, ref: ABC123              â”‚â”‚â”‚
â”‚  â”‚  â”‚      Confiance: 94%                                                 â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  [ ] ğŸ“ CrÃ©er fiche "Hotel Shibuya Tokyo"                          â”‚â”‚â”‚
â”‚  â”‚  â”‚      Type: lieu | Confiance: 72%                                    â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€ 6.2 TÃ¢ches Ã  CrÃ©er â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  [ ] â˜‘ï¸ "Imprimer confirmation hÃ´tel"                              â”‚â”‚â”‚
â”‚  â”‚  â”‚      Due: 10 mars 2026 | Confiance: 65%                            â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 7. ENTITÃ‰S EXTRAITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  ğŸ‘¤ Personnes: â€”                                                        â”‚â”‚
â”‚  â”‚  ğŸ¢ Organisations: Booking.com, Hotel Shibuya                          â”‚â”‚
â”‚  â”‚  ğŸ“ Lieux: Tokyo, Shibuya                                              â”‚â”‚
â”‚  â”‚  ğŸ“… Dates: 12-19 mars 2026                                             â”‚â”‚
â”‚  â”‚  ğŸ’° Montants: Â¥89,000 (â‰ˆ â‚¬550)                                         â”‚â”‚
â”‚  â”‚  ğŸ”— RÃ©fÃ©rences: ABC123                                                  â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€ 8. CONTENU ORIGINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  [Texte] [HTML]                                                        â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  Dear Johan,                                                        â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  Your reservation at Hotel Shibuya Tokyo is confirmed...           â”‚â”‚â”‚
â”‚  â”‚  â”‚  ...                                                                â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Sections Obligatoires

| Section | Contenu | Source DonnÃ©es |
|---------|---------|----------------|
| **1. En-tÃªte** | Sujet, expÃ©diteur, date, piÃ¨ces jointes | `metadata` |
| **2. DÃ©cision** | Action recommandÃ©e, confiance, rÃ©sumÃ©, catÃ©gorie | `analysis.action`, `analysis.confidence`, `analysis.summary` |
| **3. Transparence Analyse** | Badges, timeline multi-pass, sparkline confiance | `analysis.multi_pass` |
| **4. Contexte UtilisÃ©** | Notes, calendrier, tÃ¢ches consultÃ©s + influence | `analysis.retrieved_context`, `analysis.context_influence` |
| **5. Raisonnement** | Explication, alternatives rejetÃ©es, points d'attention | `analysis.reasoning`, `analysis.options[].why_not`, `analysis.multi_pass.high_stakes` |
| **6. Enrichissements** | Notes et tÃ¢ches proposÃ©es (avec checkboxes) | `analysis.proposed_notes`, `analysis.proposed_tasks` |
| **7. EntitÃ©s** | Personnes, organisations, lieux, dates, montants | `analysis.entities` |
| **8. Contenu** | Email original (texte/HTML) | `content` |

#### DonnÃ©es de Transparence (API)

```typescript
interface AnalysisTransparency {
  // Multi-pass (section 3)
  multi_pass: {
    passes_count: number;
    final_model: 'haiku' | 'sonnet' | 'opus';
    models_used: string[];
    escalated: boolean;
    stop_reason: 'confidence_sufficient' | 'max_passes' | 'no_changes';
    high_stakes: boolean;
    total_tokens: number;
    total_duration_ms: number;
    pass_history: PassHistoryEntry[];
  };

  // Contexte (section 4)
  retrieved_context: {
    notes: { id: string; title: string; relevance: number }[];
    calendar_events: { id: string; title: string; date: string }[];
    tasks: { id: string; title: string; due_date?: string }[];
  };

  context_influence: {
    explanation: string;
    notes_used: string[];
    confirmations: string[];
    contradictions: string[];
    missing_info: string[];
  };

  // Raisonnement (section 5)
  reasoning: string;
  options: {
    action: string;
    confidence: number;
    why_not?: string;  // Pourquoi cette option n'est pas recommandÃ©e
  }[];
}

interface PassHistoryEntry {
  pass_number: number;
  pass_type: 'blind' | 'refine' | 'deep' | 'expert';
  model: 'haiku' | 'sonnet' | 'opus';
  duration_ms: number;
  tokens: number;
  confidence_before: number;
  confidence_after: number;
  context_searched: boolean;
  notes_found: number;
  escalation_triggered: boolean;
  questions: string[];  // Thinking bubbles â€” questions pour la passe suivante
}
```

#### Comportement des Sections

| Section | Ã‰tat RepliÃ© | Ã‰tat DÃ©pliÃ© |
|---------|-------------|-------------|
| **Transparence Analyse** | Badges uniquement | Timeline complÃ¨te + sparkline |
| **Contexte UtilisÃ©** | Nombre de notes/events | Liste dÃ©taillÃ©e + influence |
| **Raisonnement** | RÃ©sumÃ© 1 ligne | Texte complet + alternatives |
| **Enrichissements** | Compteur (N notes, M tÃ¢ches) | Checkboxes Ã©ditables |
| **EntitÃ©s** | Tags inline | Liste dÃ©taillÃ©e par type |
| **Contenu** | Preview 3 lignes | Email complet (scroll) |

#### Raccourcis Clavier (Page DÃ©tail)

| Raccourci | Action |
|-----------|--------|
| `1-8` | Aller Ã  la section N |
| `E` | Toggle toutes les sections (expand/collapse) |
| `T` | Toggle transparence (section 3) |
| `C` | Toggle contexte (section 4) |
| `Space` | Scroll contenu email |

---

## 4. Synchronisation Temps RÃ©el

### 4.1 ProblÃ¨mes Actuels

- Pas de canal WebSocket pour les mises Ã  jour queue
- ModÃ¨le optimiste avec polling manuel aprÃ¨s chaque action
- Race conditions possibles entre onglets/utilisateurs
- Toggle note/task approvals non persistÃ©s

### 4.2 Solution : Canal WebSocket Queue

**Nouveau canal** : `ChannelType.QUEUE`

**Ã‰vÃ©nements Ã©mis par le backend :**

```typescript
type QueueEvent =
  | { type: 'item_added'; item: PeripetieItem }
  | { type: 'item_updated'; item_id: string; changes: Partial<PeripetieItem> }
  | { type: 'item_removed'; item_id: string }
  | { type: 'item_state_changed'; item_id: string; old_state: PeripetieState; new_state: PeripetieState }
  | { type: 'stats_updated'; stats: QueueStats }
  | { type: 'batch_started'; batch_id: string; count: number }
  | { type: 'batch_progress'; batch_id: string; processed: number; total: number }
  | { type: 'batch_completed'; batch_id: string; results: BatchResult };
```

### 4.3 Frontend Store RÃ©actif

```typescript
// Ã‰coute des Ã©vÃ©nements WebSocket
websocket.subscribe('queue', (event: QueueEvent) => {
  switch (event.type) {
    case 'item_state_changed':
      peripetiesStore.updateItemState(event.item_id, event.new_state);
      break;
    case 'stats_updated':
      peripetiesStore.setStats(event.stats);
      break;
    // etc.
  }
});
```

### 4.4 Optimistic Updates avec Reconciliation

```typescript
async function approveItem(item: PeripetieItem) {
  // 1. Sauvegarde Ã©tat actuel
  const snapshot = peripetiesStore.snapshot();

  // 2. Update optimiste
  peripetiesStore.updateItemState(item.id, 'processed');
  peripetiesStore.removeFromCurrentView(item.id);

  try {
    // 3. Appel API
    await api.approvePeripetie(item.id);
    // Le WebSocket confirmera et mettra Ã  jour les stats
  } catch (error) {
    // 4. Rollback si erreur
    peripetiesStore.restore(snapshot);
    showError('Action Ã©chouÃ©e');
  }
}
```

---

## 5. Vocabulaire et Terminologie

### 5.1 Termes Ã  Utiliser

| Terme | Usage | Ã‰viter |
|-------|-------|--------|
| **PÃ©ripÃ©tie** | Item individuel | "Email", "Courrier", "Pli", "Flux item" |
| **PÃ©ripÃ©ties** | Collection/page | "Queue", "Courrier", "Flux" |
| **Ã€ traiter** | Onglet items en attente de revue | "Pending", "En attente" |
| **ReportÃ©e** | Item snoozÃ© | "Snoozed", "Mis de cÃ´tÃ©" |
| **TraitÃ©e** | Item rÃ©solu | "Approved", "Processed" |

### 5.2 Fichiers Ã  Mettre Ã  Jour

| Fichier | Changements |
|---------|-------------|
| `peripeties/+page.svelte` | Textes "Courrier" â†’ "PÃ©ripÃ©ties" |
| `peripeties/focus/+page.svelte` | Textes "plis" â†’ "pÃ©ripÃ©ties" |
| `CommandPalette.svelte` | Labels |
| `briefing.spec.ts` | Tests E2E |
| `$lib/components/flux/` | Renommer dossier â†’ `peripeties/` |

---

## 6. API Backend

### 6.1 Nouveaux Endpoints

| MÃ©thode | Endpoint | Description |
|---------|----------|-------------|
| `GET` | `/peripeties` | Liste avec filtres par state |
| `GET` | `/peripeties/stats` | Stats par state ET par resolution |
| `GET` | `/peripeties/{id}` | DÃ©tail item |
| `POST` | `/peripeties/{id}/approve` | Approuver |
| `POST` | `/peripeties/{id}/reject` | Rejeter |
| `POST` | `/peripeties/{id}/snooze` | Reporter |
| `POST` | `/peripeties/{id}/retry` | RÃ©essayer (erreurs) |
| `DELETE` | `/peripeties/{id}` | Supprimer |

### 6.2 ParamÃ¨tres de Filtrage

```
GET /peripeties?state=awaiting_review&snoozed=false&page=1&page_size=20
GET /peripeties?state=processed&resolution_type=auto_applied
GET /peripeties?state=error&error_type=action_failed
```

### 6.3 Structure RÃ©ponse Stats

```typescript
interface PeripetiesStats {
  by_state: {
    queued: number;
    analyzing: number;
    awaiting_review: number;
    processed: number;
    error: number;
  };
  by_resolution: {
    auto_applied: number;
    manual_approved: number;
    manual_modified: number;
    manual_rejected: number;
    manual_skipped: number;
  };
  snoozed_count: number;
  oldest_awaiting: string | null;  // ISO datetime
  newest_processed: string | null;
}
```

---

## 7. Panneau de RÃ©analyse

### 7.1 Concept

Le bouton "RÃ©analyser" sur un item ouvre un panneau avec plusieurs options configurables, plutÃ´t qu'une action directe.

### 7.2 Interface du Panneau

```
â”Œâ”€ RÃ©analyser cette pÃ©ripÃ©tie â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Instruction personnalisÃ©e (optionnel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  [ Textarea pour instruction libre ]                           â”‚   â”‚
â”‚  â”‚  Ex: "Cet email concerne le projet Alpha, pas Beta"            â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Quand ? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  (â€¢) Maintenant      ( ) Plus tard (file d'attente)            â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ ModÃ¨le â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  (â€¢) Standard (Multi-pass adaptatif)                           â”‚   â”‚
â”‚  â”‚  ( ) Haiku (rapide, Ã©conomique)                                â”‚   â”‚
â”‚  â”‚  ( ) Sonnet (Ã©quilibrÃ©)                                        â”‚   â”‚
â”‚  â”‚  ( ) Opus (maximum de prÃ©cision)                               â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â”‚                              [Annuler]  [ğŸ”„ RÃ©analyser]               â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 Options

| Option | Valeurs | Description |
|--------|---------|-------------|
| **Instruction** | Texte libre ou vide | Contexte supplÃ©mentaire pour Sancho |
| **Quand** | `now` / `later` | ImmÃ©diat ou ajoutÃ© Ã  la file de rÃ©analyse |
| **ModÃ¨le** | `standard` / `haiku` / `sonnet` / `opus` | Force un modÃ¨le spÃ©cifique ou laisse le multi-pass dÃ©cider |

### 7.4 Comportement par DÃ©faut

- **Instruction** : Vide
- **Quand** : Maintenant
- **ModÃ¨le** : Standard (multi-pass adaptatif)

### 7.5 API Endpoint

```typescript
POST /peripeties/{id}/reanalyze
{
  instruction?: string;      // Instruction personnalisÃ©e
  schedule: 'now' | 'later'; // ImmÃ©diat ou file d'attente
  model?: 'standard' | 'haiku' | 'sonnet' | 'opus';  // Forcer un modÃ¨le
}
```

**RÃ©ponses :**

- `schedule: 'now'` â†’ RÃ©analyse immÃ©diate, retourne l'item mis Ã  jour
- `schedule: 'later'` â†’ AjoutÃ© Ã  la file, retourne `{ queued: true, position: N }`

### 7.6 Ã‰tats Pendant RÃ©analyse

Quand une rÃ©analyse est lancÃ©e :

1. L'item passe en `state: 'analyzing'`
2. Le frontend affiche un indicateur de progression
3. WebSocket Ã©met `item_state_changed` quand terminÃ©
4. L'item revient en `state: 'awaiting_review'` avec nouvelle analyse

### 7.7 Raccourci Clavier

| Raccourci | Action |
|-----------|--------|
| `R` | Ouvre le panneau de rÃ©analyse |
| `Shift+R` | RÃ©analyse rapide (maintenant, standard, sans instruction) |

---

## 8. Migration des DonnÃ©es

### 8.1 Mapping Ancien â†’ Nouveau

| Ancien `status` | Nouveau `state` | Nouveau `resolution.type` |
|-----------------|-----------------|---------------------------|
| `pending` | `awaiting_review` | `null` |
| `approved` | `processed` | `manual_approved` |
| `rejected` | `processed` | `manual_rejected` |
| `snoozed` | `awaiting_review` | `null` (+ `snooze` rempli) |

### 8.2 Script de Migration

```python
def migrate_queue_item(old_item: dict) -> dict:
    old_status = old_item.get('status', 'pending')

    new_item = {
        **old_item,
        'state': map_state(old_status),
        'resolution': map_resolution(old_status, old_item),
        'snooze': map_snooze(old_status, old_item),
        'error': None,
    }

    # Supprimer ancien champ
    del new_item['status']

    return new_item
```

---

## 9. Plan d'ImplÃ©mentation

### Phase 1 : Vocabulaire (ImmÃ©diat)
- [ ] Remplacer tous les "Courrier/plis/flux" par "PÃ©ripÃ©ties"
- [ ] Corriger les liens cassÃ©s (`/flux/` â†’ `/peripeties/`)
- [ ] Renommer `$lib/components/flux/` â†’ `$lib/components/peripeties/`

### Phase 2 : ModÃ¨le de DonnÃ©es (Backend)
- [ ] CrÃ©er nouveaux types `PeripetieState`, `PeripetieResolution`, etc.
- [ ] Modifier `queue_storage.py` pour supporter nouvelle structure
- [ ] Script de migration des donnÃ©es existantes
- [ ] Adapter les endpoints API

### Phase 3 : Stats Correctes
- [ ] Modifier calcul stats pour sÃ©parer par `state`
- [ ] Ajouter stats par `resolution_type`
- [ ] Corriger le bug 39 vs 18

### Phase 4 : Interface Navigation
- [ ] ImplÃ©menter les 5 onglets
- [ ] SÃ©parer barre d'actions queue
- [ ] Repositionner Mode Focus comme bouton

### Phase 5 : Temps RÃ©el
- [ ] Ajouter canal WebSocket `QUEUE`
- [ ] Ã‰mettre Ã©vÃ©nements cÃ´tÃ© backend
- [ ] ImplÃ©menter Ã©coute cÃ´tÃ© frontend
- [ ] Supprimer polling manuel

### Phase 6 : Tests et Documentation
- [ ] Mettre Ã  jour tests E2E
- [ ] Documenter nouvelle API
- [ ] Mettre Ã  jour CLAUDE.md et Skills

---

## 10. CritÃ¨res d'Acceptation

### Fonctionnels

- [ ] Le comptage affichÃ© correspond exactement aux items visibles
- [ ] Les 5 onglets affichent les bons items selon leur Ã©tat
- [ ] Le Mode Focus est accessible via bouton/raccourci sÃ©parÃ©
- [ ] Les mises Ã  jour sont instantanÃ©es sans refresh manuel
- [ ] Le vocabulaire "PÃ©ripÃ©ties" est utilisÃ© partout

### Techniques

- [ ] Aucun lien `/flux/` cassÃ©
- [ ] WebSocket queue channel fonctionnel
- [ ] Migration des donnÃ©es existantes rÃ©ussie
- [ ] Tests E2E passent Ã  100%
- [ ] Pas de rÃ©gression de performance

### UX

- [ ] Navigation intuitive entre Ã©tats
- [ ] Distinction claire entre items auto-traitÃ©s et manuels
- [ ] VisibilitÃ© sur les erreurs et possibilitÃ© de retry
- [ ] Items snoozÃ©s clairement identifiables avec date de retour

---

## 11. Annexes

### A. Raccourcis Clavier

| Raccourci | Action | Contexte |
|-----------|--------|----------|
| `F` | Mode Focus | Page principale |
| `1-5` | Onglet N | Navigation |
| `A` | Approuver | Item sÃ©lectionnÃ© |
| `R` | Rejeter | Item sÃ©lectionnÃ© |
| `S` | Snooze | Item sÃ©lectionnÃ© |
| `D` | Supprimer | Item sÃ©lectionnÃ© |
| `J/K` | Item suivant/prÃ©cÃ©dent | Liste |
| `Escape` | Retour | Mode Focus |

### B. Badges Visuels

| Badge | Signification |
|-------|---------------|
| âš¡ | TraitÃ© automatiquement |
| ğŸ” | Contexte PKM utilisÃ© |
| ğŸ§  | Analyse complexe (3+ passes) |
| ğŸ† | Opus utilisÃ© |
| ğŸ’¤ | SnoozÃ© |
| âš ï¸ | Erreur |
| ğŸ”„ | En cours d'analyse |

### C. Codes Couleur Ã‰tats

| Ã‰tat | Couleur | Hex |
|------|---------|-----|
| `queued` | Gris | `#6B7280` |
| `analyzing` | Bleu | `#3B82F6` |
| `awaiting_review` | Jaune | `#F59E0B` |
| `processed` | Vert | `#10B981` |
| `error` | Rouge | `#EF4444` |
