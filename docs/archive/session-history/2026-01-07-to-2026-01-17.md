# Scapin Session History ‚Äî 7 Janvier au 17 Janvier 2026

Ce document archive les sessions de d√©veloppement de Scapin pendant la phase finale de stabilisation et la pr√©paration de la v1.0 RC-1.

---

### Session 2026-01-17 ‚Äî Enriched Frontmatter Schema (Phase 1) ‚úÖ

**Focus** : Impl√©mentation du sch√©ma frontmatter enrichi pour meilleure compr√©hension IA du contexte

**Accomplissements** :

1. ‚úÖ **Spec FRONTMATTER_ENRICHED_SPEC.md** (~400 lignes)
   - D√©finition des 3 cat√©gories de champs : Auto-update, Propose & Validate, Manual only
   - Champs par type de note (PERSONNE, PROJET, ENTITE, REUNION, ACTIF)
   - Concept `pending_updates` pour propositions IA en attente de validation
   - Workflows background pour enrichissement continu
   - **Archive**: [FRONTMATTER_ENRICHED_SPEC.md](docs/specs/archive/FRONTMATTER_ENRICHED_SPEC.md)

2. ‚úÖ **5 nouveaux enums** (`src/passepartout/note_types.py`)
   - `Relation` : ami, famille, coll√®gue, client, partenaire, fournisseur, connaissance, administration
   - `RelationshipStrength` : forte, moyenne, faible, nouvelle
   - `ProjectStatus` : actif, en_pause, termin√©, annul√©
   - `EntityType` : entreprise, administration, association, institution, autre
   - `Category` : work, personal, finance, health, family, other

3. ‚úÖ **Dataclasses frontmatter** (`src/passepartout/frontmatter_schema.py` ~555 lignes)
   - Helper classes : PendingUpdate, Stakeholder, LinkedSource, Contact
   - BaseFrontmatter : champs communs (title, type, aliases, tags, importance...)
   - PersonneFrontmatter : relation, organization, email, phone, projects, last_contact
   - ProjetFrontmatter : status, stakeholders, budget_range, target_date
   - EntiteFrontmatter : entity_type, contacts, website, country
   - ReunionFrontmatter : participants, agenda, decisions, action_items
   - ActifFrontmatter : asset_type, location, acquisition_date, current_status

4. ‚úÖ **FrontmatterParser** (`src/passepartout/frontmatter_parser.py` ~454 lignes)
   - `parse()` : YAML dict ‚Üí dataclass typ√©e
   - `to_dict()` : dataclass ‚Üí YAML dict
   - D√©tection automatique du type depuis champ explicite ou chemin metadata
   - Parsing robuste des dates, enums, listes, objets imbriqu√©s

5. ‚úÖ **Nouvelles m√©thodes NoteManager** (`src/passepartout/note_manager.py`)
   - `get_typed_frontmatter(note_id)` ‚Üí AnyFrontmatter
   - `get_note_with_typed_frontmatter(note_id)` ‚Üí tuple[Note, AnyFrontmatter]
   - `get_aliases_index()` ‚Üí dict[alias, note_id] avec cache
   - `find_note_by_alias(alias)` ‚Üí Note | None
   - `get_all_aliases()` ‚Üí dict[note_id, list[aliases]]
   - `get_persons_with_relation(relation)` ‚Üí list[tuple[Note, PersonneFrontmatter]]

6. ‚úÖ **Tests complets** (`tests/unit/test_frontmatter_parser.py` 23 tests)
   - Parsing de chaque type de note
   - Formats datetime vari√©s
   - Valeurs fran√ßaises d'importance
   - Roundtrip s√©rialisation
   - Enums from_string()

**Fichiers cr√©√©s/modifi√©s** :
```
docs/specs/FRONTMATTER_ENRICHED_SPEC.md      # NEW (~400 lignes)
src/passepartout/note_types.py               # MODIFIED (+90 lignes)
src/passepartout/frontmatter_schema.py       # NEW (~555 lignes)
src/passepartout/frontmatter_parser.py       # NEW (~454 lignes)
src/passepartout/note_manager.py             # MODIFIED (+80 lignes)
tests/unit/test_frontmatter_parser.py        # NEW (23 tests)
```

**Tests** : 49 tests passent (26 NoteManager + 23 FrontmatterParser)

**Commit** : `e2ec6ea`

---

### Session 2026-01-17 (Suite) ‚Äî Alias Matching in ContextEngine (Phase 2) ‚úÖ

**Focus** : Int√©gration du matching par aliases dans ContextEngine pour am√©liorer la r√©cup√©ration de contexte

**Accomplissements** :

1. ‚úÖ **Analyse du ContextEngine existant**
   - 4 strat√©gies existantes : Entity, Semantic, Thread, Graph expansion
   - `_retrieve_by_entities()` utilisait uniquement la recherche vectorielle
   - Probl√®me : "Marc" dans un email ne trouvait pas forc√©ment "Marc Dupont"

2. ‚úÖ **Impl√©mentation matching par aliases** (`src/passepartout/context_engine.py`)
   - Approche en 2 phases dans `_retrieve_by_entities()` :
     1. **Phase 1** : Matching exact par alias via `find_note_by_alias()`
     2. **Phase 2** : Recherche s√©mantique vectorielle (comportement existant)
   - D√©duplication : `seen_note_ids` √©vite les doublons
   - Metadata enrichi : `match_type`: `"alias_exact"` ou `"semantic"`
   - Alias match a haute relevance (= entity.confidence)

3. ‚úÖ **Tests mis √† jour** (`tests/unit/test_context_engine.py`)
   - Fixture mocke `find_note_by_alias.return_value = None` par d√©faut
   - 2 nouveaux tests :
     - `test_retrieve_by_entities_alias_match` : v√©rifie priorit√© alias
     - `test_retrieve_by_entities_alias_deduplication` : v√©rifie pas de doublons

**Fichiers modifi√©s** :
```
src/passepartout/context_engine.py       # MODIFIED (+50 lignes)
tests/unit/test_context_engine.py        # MODIFIED (+80 lignes, 2 tests)
```

**Tests** : 26 tests ContextEngine passent

**Commit** : `28b0212`

---

### Session 2026-01-17 (Suite 2) ‚Äî Task Checkbox Toggle for OmniFocus Proposals ‚úÖ

**Focus** : Permettre aux utilisateurs de cocher/d√©cocher les t√¢ches OmniFocus propos√©es avant approbation

**Accomplissements** :

1. ‚úÖ **Interface TypeScript mise √† jour** (`web/src/lib/api/client.ts`)
   - Ajout `manually_approved: boolean | null` √† l'interface `ProposedTask`
   - Alignement avec `ProposedNote` qui avait d√©j√† ce champ

2. ‚úÖ **Store queue enrichi** (`web/src/lib/stores/queue.svelte.ts`)
   - `toggleNoteApproval(itemId, noteIndex)` : Toggle pour notes
   - `toggleTaskApproval(itemId, taskIndex)` : Toggle pour t√¢ches OmniFocus
   - Logique tri-√©tat : `null` ‚Üí auto, `true` ‚Üí forc√©, `false` ‚Üí rejet√©
   - Seuil auto-apply : confiance ‚â• 90%

3. ‚úÖ **UI Flux connect√©e** (`web/src/routes/flux/+page.svelte`)
   - Checkbox notes : `onchange={() => queueStore.toggleNoteApproval(...)}`
   - Checkbox t√¢ches : `onchange={() => queueStore.toggleTaskApproval(...)}`
   - Tooltip indique l'√©tat : "Auto", "Forc√©", "Rejet√©"
   - `isChecked` calcul√© selon `manually_approved` et confiance

4. ‚úÖ **Mock data corrig√©** (`web/src/routes/flux/test-performance/+page.svelte`)
   - Ajout `manually_approved: null` pour √©viter erreur TypeScript

**Fichiers modifi√©s** :
```
web/src/lib/api/client.ts                          # +1 ligne (interface)
web/src/lib/stores/queue.svelte.ts                 # +35 lignes (toggle functions)
web/src/routes/flux/+page.svelte                   # ~5 lignes (handlers)
web/src/routes/flux/test-performance/+page.svelte  # +1 ligne (mock)
```

**Tests** : svelte-check 0 errors

**Commit** : `f35658e`

---

### Session 2026-01-17 (Suite 3) ‚Äî Protected Scapin Fields in Apple Notes Sync (Phase 3) ‚úÖ

**Focus** : Prot√©ger les champs Scapin enrichis par l'IA lors de la synchronisation avec Apple Notes

**Probl√®me r√©solu** :
- Avant : Smart Merge √©crasait potentiellement les champs Scapin avec les donn√©es Apple
- Risque : Perte des enrichissements IA (aliases, relations, pending_updates, etc.)
- Solution : D√©finition explicite des champs prot√©g√©s et mise √† jour s√©lective

**Accomplissements** :

1. ‚úÖ **Constantes de protection** (`src/integrations/apple/notes_sync.py`)
   - `PROTECTED_SCAPIN_FIELDS` : ~50 champs qui ne doivent JAMAIS √™tre √©cras√©s
     - Base : `type`, `aliases`, `importance`, `tags`, `category`, `related`, `linked_sources`, `pending_updates`
     - Personne : `relation`, `organization`, `email`, `phone`, `projects`, etc.
     - Projet : `status`, `stakeholders`, `budget_range`, `deadline`, etc.
     - Entit√© : `entity_type`, `contacts`, `website`, etc.
     - R√©union : `participants`, `agenda`, `decisions`, `action_items`, etc.
   - `APPLE_SYSTEM_FIELDS` : 7 champs que Apple peut √©craser
     - `title`, `source`, `apple_id`, `apple_folder`, `created`, `modified`, `synced`

2. ‚úÖ **Smart Merge am√©lior√©** (`_format_scapin_note()`)
   - Lecture du frontmatter existant
   - Mise √† jour UNIQUEMENT des champs Apple syst√®me
   - Pr√©servation de tous les champs Scapin et inconnus
   - Logging des champs prot√©g√©s pour debugging

3. ‚úÖ **Suite de tests compl√®te** (`tests/unit/test_apple_notes_sync.py` ~280 lignes)
   - TestProtectedFields : 3 tests (constantes, pas d'overlap)
   - TestFormatScapinNote : 7 tests (new note, preserve, unknown, malformed)
   - TestProtectedFieldsComprehensive : 4 tests (personne, projet, pending_updates, linked_sources)

**Fichiers modifi√©s** :
```
src/integrations/apple/notes_sync.py       # +80 lignes (constantes), refactor _format_scapin_note
tests/unit/test_apple_notes_sync.py        # NEW (~280 lignes, 14 tests)
```

**Tests** : 14 tests passent, ruff 0 warnings

**Commit** : `2abaaad`

---

### Session 2026-01-17 (Suite 4) ‚Äî OmniFocus Duplicate Detection (Coherence Pass) ‚úÖ

**Focus** : Impl√©menter une v√©rification de doublons avant la cr√©ation de t√¢ches OmniFocus

**Probl√®me r√©solu** :
- Avant : Les t√¢ches OmniFocus √©taient cr√©√©es sans v√©rifier les doublons
- Risque : Cr√©ation de t√¢ches redondantes (ex: "R√©pondre √† Marc" cr√©√© 3 fois)
- Solution : Pass de coh√©rence avec d√©tection fuzzy des doublons

**Accomplissements** :

1. ‚úÖ **Nouvelles m√©thodes OmniFocusClient** (`src/integrations/apple/omnifocus.py`)
   - `search_tasks(query, include_completed, limit)` : Recherche via AppleScript
   - `check_duplicate(title, due_date, project, threshold)` : D√©tection de doublons
   - `create_task_if_not_duplicate()` : Cr√©ation s√©curis√©e avec v√©rification pr√©alable

2. ‚úÖ **Algorithme de similarit√©**
   - `_extract_keywords()` : Extraction de mots-cl√©s (filtrage stop words FR/EN)
   - `_token_similarity()` : Similarit√© Jaccard sur les tokens
   - `_calculate_similarity()` : Score pond√©r√© (titre 70%, date 20%, projet 10%)
   - Seuil configurable (d√©faut 0.8)

3. ‚úÖ **Nouveaux types**
   - `DuplicateCheckResult` : R√©sultat avec `is_duplicate`, `existing_task`, `similarity_score`
   - `OmniFocusTask.completed` : Nouveau champ pour filtrer les t√¢ches compl√©t√©es

4. ‚úÖ **Suite de tests compl√®te** (`tests/unit/test_omnifocus_duplicates.py` ~360 lignes)
   - TestDuplicateCheckResult : 2 tests
   - TestKeywordExtraction : 5 tests
   - TestTokenSimilarity : 4 tests
   - TestCalculateSimilarity : 4 tests
   - TestCheckDuplicate : 5 tests
   - TestCreateTaskIfNotDuplicate : 2 tests
   - TestParseAppleScriptDate : 4 tests

**Fichiers modifi√©s** :
```
src/integrations/apple/omnifocus.py        # +370 lignes (nouvelles m√©thodes)
tests/unit/test_omnifocus_duplicates.py    # NEW (~360 lignes, 26 tests)
```

**Tests** : 26 tests passent, ruff 0 warnings

**Commit** : `60553d4`

---

### Session 2026-01-12 (Suite 2) ‚Äî Atomic Transaction Logic for Email + Enrichments ‚úÖ

**Focus** : Refonte architecturale pour traiter email + enrichissements comme unit√© atomique

**Probl√®me r√©solu** :
- Avant : Actions email et enrichissements √©taient trait√©s s√©par√©ment
- Risque : Informations perdues si enrichissements √©chouent apr√®s archivage
- Solution : Transaction atomique avec classification required/optional

**Accomplissements** :

1. ‚úÖ **Classification Required/Optional** (`src/sancho/multi_pass_analyzer.py`)
   - M√©thode `_should_be_required()` pour d√©terminer si extraction est critique
   - Deadlines toujours requis (information critique)
   - Haute importance : d√©cisions, engagements, demandes, montants, faits, √©v√©nements
   - Moyenne importance : engagements, demandes uniquement

2. ‚úÖ **Ex√©cution atomique** (`src/jeeves/api/services/queue_service.py`)
   - `_execute_enrichments()` : Ex√©cute les enrichissements via NoteManager
   - `approve_item()` refactor√© pour le flux atomique :
     1. Ex√©cuter enrichissements requis d'abord
     2. Si √©chec ‚Üí ABORT (pas d'archivage)
     3. Ex√©cuter action email
     4. Ex√©cuter enrichissements optionnels (best-effort)

3. ‚úÖ **Confiance globale**
   - `global_confidence = min(action_confidence, min(required_extraction_confidences))`
   - Action downgrade : Archive ‚Üí Flag si enrichissements requis ont faible confiance

4. ‚úÖ **Mod√®les API enrichis** (`src/jeeves/api/models/queue.py`)
   - `ProposedNoteResponse.required: bool`
   - `ProposedNoteResponse.importance: str` (haute, moyenne, basse)

5. ‚úÖ **UI Badge "Requis"**
   - `web/src/routes/flux/+page.svelte` ‚Äî Badge rouge/orange pour enrichissements critiques
   - `web/src/routes/flux/[id]/+page.svelte` ‚Äî M√™me badge en vue d√©tail
   - `web/src/lib/api/client.ts` ‚Äî Types TypeScript mis √† jour

6. ‚úÖ **Documentation mise √† jour**
   - ARCHITECTURE.md ‚Üí Section "Atomic Transaction Logic (v2.2.1)"
   - ROADMAP.md ‚Üí v1.0.0-alpha.22 entry
   - docs/user-guide/03-flux.md ‚Üí Section "Badge Requis"

**Fichiers modifi√©s** :
```
src/sancho/multi_pass_analyzer.py          # _should_be_required(), to_dict() enrichi
src/jeeves/api/services/queue_service.py   # _execute_enrichments(), approve_item()
src/jeeves/api/models/queue.py             # required, importance fields
src/jeeves/api/routers/queue.py            # Parsing nouveaux champs
web/src/routes/flux/+page.svelte           # Badge "Requis"
web/src/routes/flux/[id]/+page.svelte      # Badge "Requis"
web/src/lib/api/client.ts                  # Types TypeScript
web/src/routes/flux/test-performance/+page.svelte  # Mock data
```

**Tests** : 44 tests convergence + queue API passent
**Commit** : `7ca48b0`

---

### Session 2026-01-12 (Suite) ‚Äî Workflow v2.2 Multi-Pass Architecture ‚úÖ

**Focus** : Conception de l'architecture multi-pass avec escalade Haiku ‚Üí Sonnet ‚Üí Opus

**Innovation cl√©** : Inversion du flux Contexte/Extraction
- v2.2 : Extraction (aveugle) ‚Üí Contexte (par entit√©s) ‚Üí Raffinement ‚Üí Application

**Accomplissements** :

1. ‚úÖ **Sp√©cification Multi-Pass** (`docs/specs/MULTI_PASS_SPEC.md` ~400 lignes)
   - Architecture compl√®te avec diagrammes
   - Crit√®res de convergence (confiance ‚â• 95%, 0 changements, max 5 passes)
   - S√©lection de mod√®le par pass
   - 3 types de prompts (blind, context, refinement)
   - Estimation des co√ªts d√©taill√©e
   - Plan d'impl√©mentation en 6 jours

2. ‚úÖ **Escalade intelligente Haiku ‚Üí Sonnet ‚Üí Opus**
   - Pass 1-3 : Haiku (rapide, √©conomique)
   - Pass 4 : Sonnet si confiance < 80%
   - Pass 5 : Opus si confiance < 75% OU high-stakes

3. ‚úÖ **High-Stakes Detection**
   - Montant financier > 10,000‚Ç¨
   - Deadline < 48 heures
   - Exp√©diteur VIP (CEO, partenaire cl√©)
   - Implications l√©gales/contractuelles

4. ‚úÖ **Recherche contextuelle pr√©cise**
   - Par entit√©s extraites (pas s√©mantique floue)
   - CrossSourceEngine : Notes, Calendar, OmniFocus, Email archive

5. ‚úÖ **Documentation mise √† jour**
   - ARCHITECTURE.md ‚Üí v2.2
   - WORKFLOW_V2_SIMPLIFIED.md ‚Üí v2.2
   - ROADMAP.md ‚Üí Sprint 7
   - docs/archive/technical/02-valets.md ‚Üí Sancho v2.2
   - docs/user-guide/06-architecture.md ‚Üí Multi-Pass v2.2

**Co√ªts estim√©s** :
```
Distribution par passes :
- 15% Pass 1 (simple)    : $2.69/mois
- 70% Pass 2 (contexte)  : $27.05/mois
- 10% Pass 3 (raffinement): $5.66/mois
- 4% Pass 4 (Sonnet)     : $9.38/mois
- 1% Pass 5 (Opus)       : $10.63/mois

TOTAL : ~$55-59/mois (vs $38/mois v2.1)
Qualit√© : 92%+ confiance moyenne (vs 75% v2.1)
```

**Prochaine √©tape** : Impl√©mentation Sprint 7 (~1,650 lignes en 6 jours)

---

### Session 2026-01-12 ‚Äî Workflow v2.1.2 Enhanced Extraction ‚úÖ

**Focus** : Am√©lioration du template d'extraction avec fuseaux horaires, dur√©e, nouveaux champs OmniFocus et r√®gles enrichies

**Accomplissements** :

1. ‚úÖ **5 nouveaux champs d'extraction**
   - `timezone` ‚Äî Fuseau horaire explicite (HF, HM, Maurice, UTC, Paris)
   - `duration` ‚Äî Dur√©e en minutes pour √©v√©nements (d√©faut 60)
   - `has_attachments` ‚Äî Pi√®ces jointes importantes (justifie archive)
   - `priority` ‚Äî Priorit√© OmniFocus (haute, normale, basse)
   - `project` ‚Äî Projet OmniFocus cible

2. ‚úÖ **Support fuseaux horaires**
   - TIMEZONE_INDICATORS dans enricher.py : Paris/HF, HM, Maurice, UTC/GMT
   - Conversion automatique vers UTC pour le calendrier
   - R√®gle : deviner selon contexte exp√©diteur si non explicite

3. ‚úÖ **R√®gles note_cible enrichies**
   - Matrice type d'extraction ‚Üí note_cible recommand√©e (14 types)
   - R√©solution d'ambigu√Øt√©s (noms partiels, inconnus, multi-cible)
   - Utilisation du contexte fourni (r√©utiliser titres exacts)

4. ‚úÖ **R√®gles draft_reply d√©taill√©es**
   - Cas d'utilisation (confirmations, remerciements, validations)
   - Cas √† √©viter (n√©gociations, conflits, d√©cisions strat√©giques)
   - Format : m√™me langue, registre adapt√©, pas de signature

5. ‚úÖ **Gestion threads email**
   - Re: extraire UNIQUEMENT nouveau contenu
   - Fwd: extraire infos originales si pertinentes
   - Ignorer contenu cit√© (lignes ">")

6. ‚úÖ **3 nouveaux exemples**
   - Exemple 13 : Fuseaux horaires diff√©rents (HM, Paris, Maurice)
   - Exemple 14 : R√©solution d'ambigu√Øt√©s avec contexte
   - Exemple 15 : Email en anglais avec draft_reply adapt√©

**Fichiers modifi√©s** :
```
src/core/models/v2_models.py     # +5 champs Extraction
src/sancho/analyzer.py           # Parse nouveaux champs
src/passepartout/enricher.py     # TIMEZONE_INDICATORS, duration, project
src/utils/date_utils.py          # Utilitaires timezone
templates/ai/v2/extraction.j2    # +418 lignes (r√®gles + exemples)
tests/unit/test_enricher.py      # +17 tests (timezone, duration, fields)
tests/unit/test_v2_models.py     # Tests nouveaux champs
```

**Tests** : 72 tests enricher+analyzer passent, ruff 0 warnings

**Commit** : `026e1ca` ‚Äî feat(v2.1.2): add timezone, duration, priority, project fields to extractions

---

### Session 2026-01-11 (Suite 3) ‚Äî Workflow v2.1.1 Extraction Types Expansion ‚úÖ

**Focus** : Extension des types d'extraction et niveaux d'importance pour une capture de connaissances plus compl√®te

**Accomplissements** :

1. ‚úÖ **Extension des types d'extraction** (5 ‚Üí 14 types)
   - **Types originaux** : decision, engagement, fait, deadline, relation
   - **Nouveaux types v2.1.1** :
     - `coordonnees` ‚Äî T√©l√©phone, adresse, email de contacts
     - `montant` ‚Äî Valeurs financi√®res, factures, contrats
     - `reference` ‚Äî Num√©ros de dossier, facture, ticket
     - `demande` ‚Äî Requ√™tes faites √† Johan
     - `evenement` ‚Äî Dates importantes sans obligation (r√©union, anniversaire)
     - `citation` ‚Äî Propos exacts √† retenir (verbatim)
     - `objectif` ‚Äî Buts, cibles, KPIs mentionn√©s
     - `competence` ‚Äî Expertise/comp√©tences d'une personne
     - `preference` ‚Äî Pr√©f√©rences de travail d'une personne

2. ‚úÖ **Extension des niveaux d'importance** (2 ‚Üí 3 niveaux)
   - `haute` (üî¥) ‚Äî Critique, impact fort, √† ne pas rater
   - `moyenne` (üü°) ‚Äî Utile, bon √† savoir
   - `basse` (‚ö™) ‚Äî Contexte, r√©f√©rence future (ex: num√©ros, coordonn√©es)

3. ‚úÖ **Mise √† jour du prompt d'extraction** (`templates/ai/v2/extraction.j2`)
   - Tableau des 14 types avec colonnes Description + OmniFocus
   - 6 exemples few-shot couvrant les cas d'usage
   - Notes explicatives (deadline vs evenement, citation en guillemets)

4. ‚úÖ **Mise √† jour de la documentation technique**
   - `docs/specs/WORKFLOW_V2_SIMPLIFIED.md` ‚Äî Version 2.1.1
   - `docs/archive/technical/06-data-models.md` ‚Äî Section 3.3 Workflow v2.1.1

**Fichiers modifi√©s** :
```
src/core/models/v2_models.py        # ExtractionType (14), ImportanceLevel (3)
src/passepartout/enricher.py        # section_names, importance_icons
src/sancho/analyzer.py              # _parse_importance simplifi√©
templates/ai/v2/extraction.j2       # Prompt complet avec 14 types
docs/specs/WORKFLOW_V2_SIMPLIFIED.md
docs/archive/technical/06-data-models.md
```

**Tests** : Workflow v2.1.1 test√© sur emails r√©els (iCloud), 6/14 types utilis√©s dans le batch test

**Commits** :
- `c3fbeb8` ‚Äî feat(v2.1.1): add 4 new extraction types
- `87adfb7` ‚Äî feat(v2.1.1): add evenement extraction type for dates
- `a12ffa9` ‚Äî feat(v2.1.1): add citation, objectif, competence, preference types
- `c369e94` ‚Äî feat(v2.1.1): add basse importance level (3-tier system)

---

### Session 2026-01-11 (Suite 2) ‚Äî Workflow v2.1 Implementation Complete ‚úÖ

**Focus** : Impl√©mentation compl√®te du pipeline d'extraction de connaissances v2.1

**Accomplissements** :

1. ‚úÖ **Day 1 : Foundations** ‚Äî Models & Config
   - `src/core/models/v2_models.py` : Extraction, AnalysisResult, EnrichmentResult, ContextNote
   - `src/core/config_manager.py` : WorkflowV2Config avec seuils configurables
   - 48 tests unitaires

2. ‚úÖ **Day 2 : Analysis** ‚Äî EventAnalyzer & Template
   - `src/sancho/analyzer.py` : Escalade automatique Haiku ‚Üí Sonnet
   - `templates/ai/v2/extraction.j2` : Prompt structur√© avec exemples
   - 24 tests unitaires

3. ‚úÖ **Day 3 : Application** ‚Äî PKMEnricher & OmniFocus
   - `src/passepartout/enricher.py` : Application extractions aux notes
   - `src/integrations/apple/omnifocus.py` : Cr√©ation t√¢ches via AppleScript
   - 58 tests unitaires

4. ‚úÖ **Day 4 : Integration** ‚Äî V2EmailProcessor & API
   - `src/trivelin/v2_processor.py` : Orchestration compl√®te du pipeline
   - `src/jeeves/api/routers/workflow.py` : 4 endpoints REST
   - `src/jeeves/api/models/workflow.py` : Mod√®les Pydantic API
   - 32 tests unitaires

5. ‚úÖ **Manual Testing with curl**
   - Tous les endpoints test√©s avec authentification JWT
   - Pipeline complet : Context (3 notes) ‚Üí Haiku ‚Üí Escalation Sonnet ‚Üí Response
   - Bugs corrig√©s : PerceivedEvent fields, retrieve_context async, template timestamp, model ID

**Commits** :
- `836c255` ‚Äî feat(workflow-v2): implement Day 4 - Integration phase
- `36b983f` ‚Äî fix(enricher): use correct config attribute notes_path
- `69d9d6e` ‚Äî fix(workflow-v2): fix runtime issues from manual testing
- `e6bb1cb` ‚Äî fix(tests): update context retrieval tests for async API

**Tests** : 162 tests Workflow v2.1, 2346 tests total (100% pass)

---

### Session 2026-01-11 (Suite) ‚Äî Workflow v2.1 Knowledge Extraction Design ‚úÖ

**Focus** : Conception et simplification radicale de l'architecture d'extraction de connaissances

**Accomplissements** :

1. ‚úÖ **Analyse critique de la spec v2.0 complexe**
   - 6 phases ‚Üí Trop complexe
   - ML local (GLiNER, SetFit) ‚Üí Overhead inutile
   - Fast Path ‚Üí Contradiction avec l'objectif d'enrichissement PKM
   - ~27 fichiers, ~$100/mois ‚Üí Pas rentable

2. ‚úÖ **D√©cision : Architecture API-First simplifi√©e (v2.1)**
   - **4 phases** au lieu de 6
   - **0 ML local** ‚Äî Tout via API Haiku
   - **Pas de Fast Path** ‚Äî Analyser TOUT (Haiku co√ªte ~$0.03/√©v√©nement)
   - **Escalade Sonnet** si confidence < 0.7
   - **~6 fichiers, ~$36/mois** ‚Äî Simple et efficace

3. ‚úÖ **8 d√©cisions de conception valid√©es**
   | Question | D√©cision |
   |----------|----------|
   | Structure notes | Hybride (r√©sum√© + historique r√©cent + archiv√©) |
   | Cr√©ation notes | Toujours demander confirmation |
   | Notes longues | Auto-archivage entr√©es > 3 mois |
   | OmniFocus projet | Matcher existant, sinon Inbox |
   | Bootstrap | Cr√©ation agressive si PKM < 50 notes |
   | Correction erreurs | Manuelle (v2.1) |
   | Limite extractions | Pas de limite |
   | Granularit√© | Beaucoup de petites notes (1 note = 1 entit√©) |

4. ‚úÖ **Documentation cr√©√©e**
   - `docs/specs/WORKFLOW_V2_SIMPLIFIED.md` (~525 lignes) ‚Äî Spec compl√®te v2.1
   - `docs/specs/WORKFLOW_V2_IMPLEMENTATION.md` (~400 lignes) ‚Äî Plan d'impl√©mentation
   - `ARCHITECTURE.md` mis √† jour avec architecture 4 phases

**Commits** :
- `1dc58d3` ‚Äî docs(workflow-v2): simplify architecture - API-first with Haiku
- `931de4d` ‚Äî docs(workflow-v2): add design decisions from discussion

---

### Session 2026-01-11 ‚Äî Email Processing Fixes (iCloud IMAP + JSON Parsing) ‚úÖ

**Focus** : Correction des probl√®mes de traitement email avec iCloud IMAP et parsing JSON

**Accomplissements** :

1. ‚úÖ **Tracking local SQLite pour emails trait√©s** (`src/integrations/email/processed_tracker.py` ~270 lignes)
   - Probl√®me : iCloud stocke les flags custom (`$MailFlagBit6`) mais ne supporte pas KEYWORD/UNKEYWORD search
   - Solution : Tracker SQLite local pour m√©moriser les emails trait√©s
   - Les flags IMAP sont toujours ajout√©s pour le feedback visuel dans les clients email

2. ‚úÖ **Optimisation batch avec early stop** (`src/integrations/email/imap_client.py`)
   - Probl√®me : Scan de 16,818 headers prenait ~43 secondes
   - Solution : Batch de 200 headers avec arr√™t d√®s qu'on a assez d'emails non trait√©s
   - R√©sultat : ~1 seconde au lieu de ~43 secondes

3. ‚úÖ **R√©paration JSON robuste** (`src/sancho/router.py`)
   - Probl√®me : Erreurs "Expecting ',' delimiter" sur les r√©ponses IA
   - Solution : Strat√©gie multi-niveaux :
     - Level 1 : Parse direct (cas id√©al)
     - Level 2 : Librairie `json-repair` (g√®re les cas complexes)
     - Level 3 : Regex cleaning + json-repair (dernier recours)
   - R√©sultat : Tous les emails pars√©s avec succ√®s

**Fichiers cr√©√©s/modifi√©s** :
```
src/integrations/email/processed_tracker.py  # NEW (~270 lignes)
src/integrations/email/imap_client.py        # MODIFIED (batch + tracking)
src/sancho/router.py                         # MODIFIED (JSON repair)
src/trivelin/processor.py                    # MODIFIED (message_id)
src/jeeves/api/services/queue_service.py     # MODIFIED (message_id)
```

**Tests** : 58 tests passent, ruff 0 warnings

**Commit** : `e47428c` ‚Äî fix(email): fix iCloud IMAP tracking and JSON parsing issues

---

### Session 2026-01-09 (Suite 7) ‚Äî Bug Fixes Performance & Stabilit√© ‚úÖ

**Focus** : Correction des bugs critiques de performance et de stabilit√©

**Accomplissements** :

1. ‚úÖ **Performance `get_all_notes()` optimis√©e** (`src/passepartout/note_manager.py`)
   - Probl√®me : Relecture de tous les fichiers √† chaque requ√™te (~1 minute)
   - Solution : Utilisation du cache m√©moire quand disponible
   - R√©sultat : 19ms au lieu de minutes

2. ‚úÖ **Apple Notes timeout augment√©** (`src/integrations/apple/notes_client.py`)
   - Probl√®me : Timeout 30s trop court pour le dossier "Notes" (583 notes)
   - Solution : Timeout augment√© √† 180s (3 minutes)

3. ‚úÖ **SQLite thread-safety corrig√©** (`src/passepartout/note_metadata.py`)
   - Probl√®me : `sqlite3.ProgrammingError` threads
   - Solution : `check_same_thread=False` avec connection pooling

4. ‚úÖ **Valets API wrapp√©e dans APIResponse** (`src/jeeves/api/routers/valets.py`)
   - Probl√®me : Frontend attendait `{success, data}`, API retournait donn√©es brutes
   - Solution : Tous les endpoints wrapp√©s avec `APIResponse`

5. ‚úÖ **SSR d√©sactiv√© pour SPA** (`web/src/routes/+layout.ts`)
   - Probl√®me : Navigation directe vers /login, /notes √©chouait
   - Solution : `export const ssr = false`

**Commits** :
- `6befe16` ‚Äî perf(passepartout): add vector index persistence to disk
- `6f7fd86` ‚Äî fix: multiple performance and stability improvements
- `d80d2f1` ‚Äî fix(web): disable SSR for SPA mode

**Bugs identifi√©s** : ‚úÖ Tous r√©solus (#41-#46)

---

### Session 2026-01-09 (Suite 6) ‚Äî UI Notes Apple-like & Revue SM-2 ‚úÖ

**Focus** : Refonte compl√®te de l'UI Notes style Apple Notes + M√©tadonn√©es de revue SM-2

**Accomplissements** :

1. ‚úÖ **UI Notes 3 colonnes style Apple Notes** (`web/src/routes/notes/+page.svelte` ~630 lignes)
   - Colonne 1 (224px) : Arbre de dossiers avec expansion/collapse
   - Colonne 2 (288px) : Liste des notes group√©es par date
   - Colonne 3 (flexible) : Contenu de la note avec m√©tadonn√©es
   - S√©lection ambr√©e (Apple Notes style)
   - Auto-s√©lection du premier dossier et de la premi√®re note

2. ‚úÖ **Dossiers virtuels**
   - "Toutes les notes" (üìã) en haut avec compteur total
   - "Supprim√©es r√©cemment" (üóëÔ∏è) en bas
   - S√©parateur visuel entre dossiers r√©guliers et virtuels

3. ‚úÖ **M√©tadonn√©es de revue SM-2** (section dans le panneau note)
   - Prochaine revue (format√©e en fran√ßais)
   - Nombre de revues effectu√©es
   - Facteur de facilit√© (easiness factor)
   - Intervalle actuel (heures/jours)
   - Type de note et importance
   - Derni√®re √©valuation (0-5)
   - Badge "Revue due" si applicable

4. ‚úÖ **Actions sur les notes**
   - Bouton üîÑ pour d√©clencher une revue imm√©diate
   - Bouton ‚ÜóÔ∏è pour ouvrir dans une nouvelle fen√™tre
   - Indicateur de revue due (point orange) sur les notes dans la liste

5. ‚úÖ **Sync Apple Notes am√©lior√©**
   - Indicateur de progression pendant la sync
   - Affichage de la date de derni√®re synchronisation
   - Compteur de notes synchronis√©es

6. ‚úÖ **Performance : Singleton cache pour NotesService** (`src/jeeves/api/deps.py`)
   - Probl√®me : Chaque requ√™te API cr√©ait un nouveau `NoteManager` avec `auto_index=True`
   - Impact : 1+ minute de chargement pour r√©-indexer 227 notes
   - Solution : Cache singleton du `NotesService`
   - R√©sultat : Chargement quasi-instantan√©

7. ‚úÖ **Tri alphab√©tique des dossiers** (`src/jeeves/api/services/notes_service.py`)
   - Tri insensible √† la casse (comme Apple Notes)

8. ‚úÖ **Bug fix : Page /valets** (`src/jeeves/api/routers/valets.py`)
   - Probl√®me : Type `_user: str` au lieu de `Optional[TokenData]`
   - Erreur : `sqlite3.ProgrammingError: type 'TokenData' is not supported`
   - Solution : Import et utilisation du bon type

---

### Session 2026-01-09 (Suite 5) ‚Äî Backend Unavailability Detection ‚úÖ

**Focus** : D√©tection et feedback utilisateur quand le backend n'est pas disponible

**Accomplissements** :

1. ‚úÖ **Script dev.sh** (`scripts/dev.sh` ~85 lignes)
   - Lance backend et frontend ensemble
   - V√©rifie si le backend tourne d√©j√†
   - Attend que le backend soit pr√™t avant le frontend
   - Cleanup propre avec Ctrl+C

2. ‚úÖ **NPM script dev:full** (`web/package.json`)
   - `npm run dev:full` ‚Üí lance `./scripts/dev.sh`
   - Alternative pratique √† la commande shell

3. ‚úÖ **Auth store am√©lior√©** (`web/src/lib/stores/auth.svelte.ts`)
   - Ajout √©tat `backendAvailable`
   - Fonction `retryConnection()` pour r√©essayer la connexion
   - D√©tection erreur r√©seau (status 0)

4. ‚úÖ **UI Backend non disponible** (`web/src/routes/login/+page.svelte`)
   - Message clair "Backend non disponible"
   - Instruction: `./scripts/dev.sh`
   - Bouton "R√©essayer" avec √©tat de chargement

---

### Session 2026-01-09 (Suite 3) ‚Äî Guide Utilisateur ‚úÖ

**Focus** : R√©daction du guide utilisateur complet

**Accomplissements** :

1. ‚úÖ **Guide utilisateur en 7 sections** (~1500 lignes)
   - `01-demarrage.md` ‚Äî Installation, configuration, premiers pas
   - `02-briefing.md` ‚Äî Briefing matinal, pr√©-r√©union, conflits
   - `03-flux.md` ‚Äî Traitement emails, actions, entit√©s
   - `04-notes.md` ‚Äî Base de connaissances, r√©vision SM-2, Git
   - `05-journal.md` ‚Äî Journaling quotidien, feedback, calibration
   - `06-architecture.md` ‚Äî Les valets, pipeline cognitif, flux de donn√©es
   - `07-configuration.md` ‚Äî Variables .env, YAML, int√©grations

2. ‚úÖ **Page /help in-app**
   - Sections r√©sum√©es avec ic√¥nes
   - FAQ (4 questions fr√©quentes)
   - Liens vers ressources externes
   - Raccourcis clavier

---

### Session 2026-01-08 (Suite 2) ‚Äî Cross-Source COMPL√âT√â : WhatsApp, Files, Web Adapters ‚úÖ

**Focus** : Impl√©mentation des 3 derniers adaptateurs pour compl√©ter CrossSourceEngine

**Accomplissements** :

1. ‚úÖ **WhatsApp Adapter** (`src/passepartout/cross_source/adapters/whatsapp_adapter.py` ~480 lignes)
   - Recherche dans l'historique SQLite WhatsApp
   - Support schemas iOS backup et Android
   - Filtres : query, contact, since (days_back)
   - D√©tection automatique du sch√©ma de base de donn√©es
   - Scoring de pertinence : content match, contact match, recency

2. ‚úÖ **Files Adapter** (`src/passepartout/cross_source/adapters/files_adapter.py` ~475 lignes)
   - Recherche dans les fichiers locaux
   - Primary : ripgrep (rg) pour performance
   - Fallback : recherche Python native
   - Filtres : extensions, exclude_dirs, path, max_file_size
   - Scoring de pertinence : filename match, content match, recency, file type

3. ‚úÖ **Web Adapter** (`src/passepartout/cross_source/adapters/web_adapter.py` ~410 lignes)
   - Primary : Tavily API (AI-optimized search)
   - Fallback : DuckDuckGo (duckduckgo-search library)
   - Filtres : include_domains, exclude_domains, search_depth, topic
   - Factory function `create_web_adapter()` pour s√©lection automatique
   - Support AI-generated answers + web results

4. ‚úÖ **Tests complets** (`tests/unit/test_cross_source_new_adapters.py` ~700 lignes, 49 tests)
   - TestWhatsAppAdapter : 14 tests
   - TestFilesAdapter : 14 tests
   - TestWebAdapter : 15 tests
   - TestDuckDuckGoAdapter : 3 tests
   - TestCreateWebAdapter : 3 tests
   - TestAdapterIntegration : 3 tests

---

### Session 2026-01-08 (Suite) ‚Äî Cross-Source Phase 2 : Calendar & Teams Adapters ‚úÖ

**Focus** : Impl√©mentation des adaptateurs Calendar et Teams pour CrossSourceEngine

**Accomplissements** :

1. ‚úÖ **Teams Adapter** (`src/passepartout/cross_source/adapters/teams_adapter.py` ~315 lignes)
   - Recherche dans les messages Teams via Microsoft Graph API
   - Filtres : query, chat_filter, mentions_only, since
   - Matching : content, sender, chat topic, attachments
   - Scoring de pertinence : content match, recency, importance, mentions

2. ‚úÖ **Calendar Adapter am√©lior√©** (`src/passepartout/cross_source/adapters/calendar_adapter.py`)
   - Fix config field names : `days_behind`/`days_ahead` ‚Üí `past_days`/`future_days`
   - Simplification code : `for` loops ‚Üí `any()` (ruff SIM110)
   - Suppression imports inutilis√©s

3. ‚úÖ **Tests complets** (`tests/unit/test_cross_source_adapters.py` ~700 lignes, 29 tests)
   - TestCalendarAdapter : 12 tests
   - TestTeamsAdapter : 14 tests
   - TestAdapterIntegration : 3 tests

---

### Session 2026-01-08 ‚Äî Sprint 3 : UI Brouillons & Code Review ‚úÖ

**Focus** : UI Brouillons email + Revue de code approfondie Sprint 3

**Accomplissements** :

1. ‚úÖ **UI Brouillons Email compl√®te**
   - `web/src/routes/drafts/+page.svelte` ‚Äî Page liste avec filtres (~335 lignes)
   - `web/src/routes/drafts/[id]/+page.svelte` ‚Äî Page √©dition (~434 lignes)
   - 10 fonctions API client (list, get, create, update, send, discard, delete...)
   - Navigation sidebar ajout√©e

2. ‚úÖ **Code Review Sprint 3** ‚Äî Analyse approfondie en 4 axes parall√®les
   - S√©curit√© : XSS, injection, CSRF
   - Architecture : Race conditions, memory leaks
   - Qualit√© : Code mort, duplication, types
   - Performance : Optimisation, debouncing

3. ‚úÖ **Security Fixes**
   - XSS: `{@html}` remplac√© par iframe sandbox√©e dans `flux/[id]/+page.svelte`
   - iframe sandbox: `allow-same-origin` retir√© (trop permissif)

---

### Session 2026-01-07 ‚Äî Backlog Review & Sprint 2 Planning ‚úÖ

**Focus** : Revue du backlog, cr√©ation d'issues, planification Sprint 2

**Accomplissements** :

1. ‚úÖ **Issues cr√©√©es** : #37 (Pi√®ces jointes), #38 (Organisation fichiers), #39 (WhatsApp context), #40 (ContextEngine connection)
2. ‚úÖ **ContextEngine non connect√©** : Infrastructure identifi√©e mais manquante dans le pipeline.
3. ‚úÖ **Backlog Sprint 2 prioris√©** : #40 ‚Üí #36 ‚Üí #35 ‚Üí #11 ‚Üí #17

---

### Session 2026-01-07 (Suite) ‚Äî Sprint 2 : ContextEngine Connection ‚úÖ

**Focus** : Impl√©mentation de l'issue #40 ‚Äî Connexion ContextEngine au CognitivePipeline

**Accomplissements** :

1. ‚úÖ **Configuration ProcessingConfig** (`src/core/config_manager.py`)
2. ‚úÖ **Initialisation ContextEngine** (`src/trivelin/processor.py`)
3. ‚úÖ **Propagation param√®tres** (`src/trivelin/cognitive_pipeline.py`)
4. ‚úÖ **ReasoningEngine configurable** (`src/sancho/reasoning_engine.py`)
5. ‚úÖ **Tests Passepartout r√©activ√©s**
6. ‚úÖ **UI context_used** (`web/src/routes/flux/+page.svelte`)

---

### Session 2026-01-07 (Suite 2) ‚Äî Bouton "Discuter de cette note" ‚úÖ

**Focus** : Impl√©mentation du chat contextuel depuis les pages de notes

**Accomplissements** :

1. ‚úÖ **Store note-chat** (`web/src/lib/stores/note-chat.svelte.ts` ~430 lignes)
2. ‚úÖ **ChatPanel dual-mode** (`web/src/lib/components/layout/ChatPanel.svelte`)
3. ‚úÖ **Bouton üí¨ sur page note**
4. ‚úÖ **Corrections types**

---

### Session 2026-01-07 (Suite 3) ‚Äî Apple Notes Sync ‚úÖ

**Focus** : Impl√©mentation de la synchronisation bidirectionnelle Apple Notes

**Accomplissemnts** :

1. ‚úÖ **Mod√®les Apple Notes** (`src/integrations/apple/notes_models.py`)
2. ‚úÖ **Client AppleScript** (`src/integrations/apple/notes_client.py`)
3. ‚úÖ **Service de synchronisation** (`src/integrations/apple/notes_sync.py`)
4. ‚úÖ **API impl√©ment√©e**
5. ‚úÖ **Test r√©el** : 227 notes synchronis√©es avec succ√®s
