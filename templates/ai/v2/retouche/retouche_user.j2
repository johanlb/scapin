{# Retouche User Prompt (DYNAMIC) #}
{# Contient les données de la note à analyser #}

## Note à analyser

**Titre** : {{ note.title }}
**Type** : {{ note_type | default('inconnu') }}
**Mots** : {{ word_count }}
**Dernière modification** : {{ updated_at | default('Non disponible') }}
**Score actuel** : {{ quality_score | default('Non évalué') }}

{% if frontmatter %}
## Frontmatter

```yaml
{{ frontmatter }}
```
{% endif %}

## Contenu

{{ content[:3000] }}
{% if content | length > 3000 %}
[... contenu tronqué, {{ content | length }} caractères au total ...]
{% endif %}

{% if linked_notes %}
## Notes liées (contexte)

{% for title, excerpt in linked_notes.items() %}
### [[{{ title }}]]
{{ excerpt[:200] }}{% if excerpt | length > 200 %}...{% endif %}

{% endfor %}
{% endif %}

{% if template_structure %}
## Modèle de référence (structure attendue)

Voici la structure type pour une fiche **{{ note_type }}**. Utilise ce modèle comme référence pour restructurer la note si nécessaire :

```
{{ template_structure[:2000] }}
{% if template_structure | length > 2000 %}
[... modèle tronqué ...]
{% endif %}
```

**Important** : Adapte les sections à ce modèle lors d'une action "structure". Les sections entre crochets [exemple] sont à remplacer par le contenu réel.
{% endif %}

## Instructions spécifiques

{% if note_type == 'inconnu' %}
**⚠️ PRIORITÉ : Cette note n'a pas de type défini.**

Analyse le contenu et propose une action `assign_type` avec le type le plus approprié parmi :
- personne (fiche contact, informations sur une personne)
- projet (projet en cours ou terminé)
- reunion (compte-rendu de réunion, notes de meeting)
- entite (entreprise, organisation, copropriété, concept abstrait)
- processus (procédure, workflow, méthode)
- evenement (événement ponctuel, anniversaire, voyage)
- souvenir (mémoire personnelle, anecdote)
- autre (si aucun type ci-dessus ne convient)

{% include 'retouche/generique.j2' %}
{% elif note_type == 'personne' %}
{% include 'retouche/personne.j2' %}
{% elif note_type == 'projet' %}
{% include 'retouche/projet.j2' %}
{% elif note_type == 'reunion' %}
{% include 'retouche/reunion.j2' %}
{% elif note_type == 'entite' %}
{% include 'retouche/entite.j2' %}
{% elif note_type == 'processus' %}
{% include 'retouche/processus.j2' %}
{% elif note_type == 'evenement' %}
{% include 'retouche/evenement.j2' %}
{% else %}
{% include 'retouche/generique.j2' %}
{% endif %}

## Réponse attendue

Réponds en JSON valide avec cette structure exacte :
```json
{
  "quality_score": 0-100,
  "reasoning": "Analyse globale de la note",
  "actions": [
    {
      "type": "action_type",
      "target": "section ou champ ciblé",
      "content": "nouveau contenu (si applicable)",
      "confidence": 0.0-1.0,
      "reasoning": "justification de l'action"
    }
  ]
}
```
