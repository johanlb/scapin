{# Retouche User Prompt (DYNAMIC) #}
{# Contient les donn√©es de la note √† analyser #}

## Note √† analyser

**Titre** : {{ note.title }}
**Type** : {{ note_type | default('inconnu') }}
**Mots** : {{ word_count }}
**Derni√®re modification** : {{ updated_at | default('Non disponible') }}
**Score actuel** : {{ quality_score | default('Non √©valu√©') }}

{% if canevas %}
## Contexte permanent de Johan (Canevas)

Tu dois garder en t√™te le profil, les projets et objectifs de Johan pour √©valuer la pertinence et prioriser les actions :

{{ canevas }}

---
{% endif %}

{% if frontmatter %}
## Frontmatter

```yaml
{{ frontmatter }}
```
{% endif %}

## Contenu

{{ content[:3000] }}
{% if content | length > 3000 %}
[... contenu tronqu√©, {{ content | length }} caract√®res au total ...]
{% endif %}

{% if linked_notes %}
## Notes li√©es (contexte)

{% for title, excerpt in linked_notes.items() %}
### [[{{ title }}]]
{{ excerpt[:200] }}{% if excerpt | length > 200 %}...{% endif %}

{% endfor %}
{% endif %}

{% if template_structure %}
## Mod√®le de r√©f√©rence (structure attendue)

Voici la structure type pour une fiche **{{ note_type }}**. Utilise ce mod√®le comme r√©f√©rence pour restructurer la note si n√©cessaire :

```
{{ template_structure[:2000] }}
{% if template_structure | length > 2000 %}
[... mod√®le tronqu√© ...]
{% endif %}
```

**Important** : Adapte les sections √† ce mod√®le lors d'une action "structure". Les sections entre crochets [exemple] sont √† remplacer par le contenu r√©el.
{% endif %}

## Sections d'enrichissement automatique (NE PAS SUPPRIMER)

Ces sections sont ajout√©es automatiquement par Scapin lors du traitement des emails. Elles contiennent des informations tra√ßables avec leur source. **Ne jamais les supprimer ni les d√©placer dans d'autres sections.**

**Formats reconnus :**
- `## Engagements` / `## Informations` / `## Faits` / `## D√©cisions` / `## Jalons`
  Format : `- üî¥ **YYYY-MM-DD** : [contenu] ‚Äî [source](scapin://event/xxx)`
  (üî¥ = haute importance, üü° = moyenne, ‚ö™ = basse)

- `## Questions ouvertes`
  Format : `### ‚ùì [Question]\n- **Cat√©gorie** : ...\n- **Source** : ...\n- **Ajout√©e le** : ...`

- `## Recherche Web`
  Format : `**[Titre]**\n[Contenu...]\n> Source: [URL]`

**R√®gle critique** : Si tu vois ces sections dans la note, pr√©serve-les int√©gralement. Tu peux sugg√©rer de compl√©ter les autres sections de la fiche, mais ne touche JAMAIS aux enrichissements automatiques.

## Instructions sp√©cifiques

{% if note_type == 'inconnu' %}
**‚ö†Ô∏è PRIORIT√â : Cette note n'a pas de type d√©fini.**

Analyse le contenu et propose une action `assign_type` avec le type le plus appropri√© parmi :
- personne (fiche contact, informations sur une personne)
- projet (projet en cours ou termin√©)
- reunion (compte-rendu de r√©union, notes de meeting)
- entite (entreprise, organisation, copropri√©t√©, concept abstrait)
- processus (proc√©dure, workflow, m√©thode)
- evenement (√©v√©nement ponctuel, anniversaire, voyage)
- souvenir (m√©moire personnelle, anecdote)
- autre (si aucun type ci-dessus ne convient)

{% include 'retouche/generique.j2' %}
{% elif note_type == 'personne' %}
{% include 'retouche/personne.j2' %}
{% elif note_type == 'projet' %}
{% include 'retouche/projet.j2' %}
{% elif note_type == 'reunion' %}
{% include 'retouche/reunion.j2' %}
{% elif note_type == 'entite' %}
{% include 'retouche/entite.j2' %}
{% elif note_type == 'processus' %}
{% include 'retouche/processus.j2' %}
{% elif note_type == 'evenement' %}
{% include 'retouche/evenement.j2' %}
{% else %}
{% include 'retouche/generique.j2' %}
{% endif %}

## R√©ponse attendue

R√©ponds en JSON valide avec cette structure exacte :
```json
{
  "quality_score": 0-100,
  "reasoning": "Analyse globale de la note",
  "actions": [
    {
      "type": "action_type",
      "target": "section ou champ cibl√©",
      "content": "nouveau contenu (si applicable)",
      "confidence": 0.0-1.0,
      "reasoning": "justification de l'action"
    }
  ]
}
```
